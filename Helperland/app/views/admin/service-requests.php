<div class="service_requests">
    <div>
        <p>Service Requests</p>
    </div>
    <div>
        <input class="input" type="text" placeholder="Service ID"  onkeyup="search_by_service_id(this.value)">
        <input class="input" type="text" placeholder="Postal Code"  onkeyup="search_by_postal_code(this.value)">
        <!-- <input class="input" type="text" placeholder="Email"> -->
        <input class="input" type="text" placeholder="Customer"  onkeyup="search_by_customer(this.value)">
        <input class="input" type="text" placeholder="Service Provider" onkeyup="search_by_service_provider(this.value)">
        <!-- <select class="select" name="" id="">
            <option value="">Customer</option>
        </select> -->
        <!-- <select class="select" name="" id="">
            <option value="">Service Provider</option>
        </select> -->
        <select class="select" name="serviceStatusSelect" id="" onchange="search_by_service_status(this.value)">
            <option value="">All</option>
            <option value="New">New</option>
            <option value="Assigned">Assigned</option>
            <option value="Completed">Completed</option>
            <option value="Cancelled">Cancelled</option>
        </select>
        <div class="from_date">
            <label for="from_date">
                <img src="<?= assets('assets/img/table/calendar_blue.png'); ?>" alt="">
            </label>
            <input type="date" id="from_date" onchange="search_by_from_date(this.value)">
            <span>From</span>
        </div>
        <div class="to_date">
            <label for="to_date">
                <img src="<?= assets('assets/img/table/calendar_blue.png'); ?>" alt="">
            </label>
            <input type="date" id="to_date" onchange="search_by_to_date(this.value)">
            <span>To</span>
        </div>
        <!-- <button class="search_btn">Search</button> -->
        <button class="clear_btn" onclick="clear_all_value()">Clear</button>
    </div>
</div><!-- END_SERVICE_REQUESTS -->

<table id="admin_service_requests_table">
    <thead>
        <tr>
            <th>Service ID</th>
            <th>Service Date</th>
            <th>Customer Details</th>
            <th>Service Provider</th>
            <th>Status</th>
            <th>Total Payment</th>
            <th>Actions</th>
        </tr>
    </thead>
    <tbody>
        <!-- DYNAMIC GENERATED BY DATATABLE -->
    </tbody>
</table>


<script>
    $(document).ready(function(){
        state.admin_service_requests_table = $('#admin_service_requests_table').DataTable({
            searching : true,
            serviceSide : true,
            autoWidth : false,
            dom : 't<"datatable_bottom"lp>',
            ajax : {
                url : `${BASE_URL}/admin/service-requests`,
                cache : true,
                dataSrc : function(data){
                    state.admin_service_requests_data = data;
                    return data;
                }
            },
            columns : [
                {
                    render : function(data, type, row){
                        return `${row.ServiceRequestId}`;
                    }
                },
                {
                    render : function(data, type, row){
                        return `<div class="service_date">
                                    <div>
                                        <img src="<?= assets('assets/img/table/calendar.png'); ?>" alt="">
                                        <p>${row.ServiceDate}</p>
                                    </div>
                                    <div>
                                        <img src="<?= assets('assets/img/table/time.png'); ?>" alt="">
                                        <p>${row.StartTime} - ${row.EndTime}</p>
                                    </div>    
                                </div>`;
                    }
                },
                {
                    render : function(data, type, row){
                        return `<div class="customer_details">
                                    <p>${row.Customer.FirstName} ${row.Customer.LastName}</p>
                                    <div>
                                        <img src="<?= assets('assets/img/table/home.png'); ?>" alt="">
                                        <p>${row.AddressLine1} ${row.AddressLine2},${row.PostalCode} ${row.City}</p>
                                    </div>
                                </div>`;
                    }
                },
                {
                    render : function(data, type, row){
                        if(row.ServiceProvider!==undefined){
                            return `
                                <div class="service_provider" onclick="show_service_details(${row.ServiceRequestId});">
                                    <img class="hat_style" src="${BASE_URL}/assets/img/avatar/${row.ServiceProvider.UserProfilePicture}.png" alt="">
                                    <div>
                                        <p>${row.ServiceProvider.FirstName} ${row.ServiceProvider.LastName}</p>    
                                        <div>
                                            ${(function(){
                                                let rating_html = ``;
                                                if(row.ServiceProvider.Rating!==undefined){
                                                    // FOR RATED STAR...
                                                    for(let i=0; i<parseInt(row.ServiceProvider.Rating); i++){
                                                        rating_html +=`<i class="fas fa-star rated_star"></i>`;
                                                    }
                                                    // FOR UNRATED STAR...
                                                    for(let i=0; i<(5-parseInt(row.ServiceProvider.Rating)); i++){
                                                        rating_html +=`<i class="fas fa-star unrated_star"></i>`;
                                                    }
                                                }
                                                else{
                                                    for(let i=0; i<5; i++){
                                                        rating_html +=`<i class="fas fa-star unrated_star"></i>`;
                                                    }
                                                }
                                                return rating_html;
                                            })()}
                                            <span>${row.ServiceProvider.Rating!==undefined?parseFloat(row.ServiceProvider.Rating):''}</span>
                                        </div>
                                    </div>
                                </div>
                            `;
                        }
                        else{
                            return `NO SP`;
                        }
                    }
                },
                {
                    render : function(data, type, row){
                        switch(row.Status){
                            case 0:
                                return `<p class="new_status">New</p>`;
                            case 1:
                                return `<p class="pending_status">Assigned</p>`;
                            case 2:
                                return `<p class="completed_status" onclick="show_service_details(${row.ServiceRequestId});">Completed</p>`;
                            case 3:
                                return `<p class="cancelled_status" onclick="show_service_details(${row.ServiceRequestId});">Cancelled</p>`;
                        }
                    }
                },
                {
                    render : function(data, type, row){
                        return `<p class="payment_text">â‚¹${row.TotalCost}</p>`;
                    }
                },
                {
                    render : function(data, type, row){
                        return `<div class="dropdown">
                                    <button class="dropdown_btn"><i class="fas fa-ellipsis-v"></i></button>
                                    <div class="dropdown_menu d_none">
                                        <a href="javascript:void(0)">Reschedule</a>
                                        <a href="javascript:void(0)">Cancel</a>
                                        <!--
                                        <a href="">Edit</a>
                                        <a href="">Change SP</a>
                                        <a href="">Escalate</a>
                                        <a href="">History Log</a>
                                        <a href="">Download Invoice</a>
                                        -->
                                    </div>
                                </div>`;                    
                    },
                    sortable : false
                },
            ],
            pagingType : 'full_numbers',
            language : {
                paginate : {
                    first    :'<i class="fa-solid fa-backward-step"></i>',
                    previous :'<i class="fas fa-angle-left">',  
                    next     :'<i class="fas fa-angle-right">',
                    last     :'<i class="fa-solid fa-forward-step"></i>'  
                },
            },
        }).on('click', '.dropdown_btn', ()=>{
            dropdown_issue_callback();
        });
    });


    function search_by_service_id(val){
        state.admin_service_requests_table.column(0).search(val).draw();
    }

    function search_by_postal_code(val){
        state.admin_service_requests_table.column(2).search(val).draw();
    }

    function search_by_customer(val){
        state.admin_service_requests_table.column(2).search(val).draw();
    }

    function search_by_service_provider(val){
        state.admin_service_requests_table.column(3).search(val).draw();
    }

    function search_by_service_status(val){
        state.admin_service_requests_table.column(4).search(val).draw();
    }

    function search_by_from_date(val){
        state.admin_service_requests_table.column(3).search(val).draw();
    }

    function search_by_to_date(val){
        state.admin_service_requests_table.column(3).search(val).draw();
    }


    function clear_all_value(){
        $('input').val('').keyup();
        $('[name="serviceStatusSelect"]').val('').change();
    }


</script>
